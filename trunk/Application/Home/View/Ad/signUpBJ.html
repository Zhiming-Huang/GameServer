<!DOCTYPE html>
<html>
    <head>
        <title>萝卜兼职-北京</title>
        <include file="Common/header"/>

        <script id ="province-list-tpl" type='text/html'>
            {{each option as value index}}
                {{if value.status==1}}
                    <option value="{{value.id}}"{{value.id == current?'selected':''}}>{{value.name}}</option>
                {{/if}}
            {{/each}}
        </script> 
        <script id ="city-list-tpl" type='text/html'>
            {{each option as value index}}
                {{if value.status==1}}
                    <option value="{{value.id}}"{{value.id == current?'selected':''}}>{{value.name}}</option>
                {{/if}}
            {{/each}}
        </script> 
        <script id ="school-list-tpl" type='text/html'>
            {{each option as value index}}
                {{if value.status==1}}
                    <option value="{{value.id}}"{{value.id == current?'selected':''}}>{{value.name}}</option>
                {{/if}}
            {{/each}}
        </script> 
        <script id ="grade-list-tpl" type='text/html'>
            {{each option as value index}}
                <option value="{{value}}"{{value == current ?'selected':''}}>{{value}}</option>
            {{/each}}
        </script>
        <script id ="region-list-tpl" type='text/html'>
            {{each option as value index}}
                <option value="{{value.id}}"{{value.id == current ?'selected':''}}>{{value.name}}</option>
            {{/each}}
        </script>
        <style>
            .line_b:after{
                border-style: none !important;
            }
            .form-reg-new .wrapRegCont div select {
                width: 100%;
                height: 100%;
                border: none;
                appearance:none;
                -moz-appearance:none;
                -webkit-appearance:none;
                padding: 0;
            }
        </style>
    </head>
    <body>
	<div class="page" id="signUp">
	    <header class="bar bar-nav">
            <h1 class="title">个人注册</h1>
        </header>
        <div class="content">
            <div>
                <img src="/Public/images/bg_sign.jpg" alt="萝卜头像" class="img-responsive">
            </div>   
            <form action="__MODULE__/Mobile/doNewReg" method="post" id="form-reg" class="form-reg-new">
                <div class="content-block f14 wrapRegCont">
                    <div class="row no-gutter line_b">
                        <div class="col-25 text-left">
                            姓&nbsp;&nbsp;名
                        </div>
                        <div class="col-75 line_l">
                            <input class="form-control gttv" type="text" name="realname" placeholder="姓名" />
                        </div>
                    </div>   
                    <div class="row no-gutter line_b">
                        <div class="col-25 text-left">
                            手机号
                        </div>
                        <div class="col-75 line_l">
                            <input class="form-control gttv" type="text" name="phone" placeholder="请输入11位手机号码" />
                        </div>
                    </div>
                    <div class="row no-gutter line_b">
                        <div class="col-25 text-left">
                            验证码
                        </div>
                        <div class="col-40 line_l">
                            <input class="form-control gttv" type="text" name="captcha" placeholder="请输入6位验证码" />
                        </div>
                        <div class="col-33 f_right">
                            <button class="btn btn-block gtbtn" type="button" id="getCaptcha" style="color:#fff;">
                                获取验证码
                            </button>
                        </div>
                    </div>
                    <div class="row no-gutter line_b" style="display: none;">
                        <div class="col-25 text-left">
                            图形验证码
                        </div>
                        <div class="col-40 line_l">
                            <input class="form-control gttv" type="text" name="verifyCode" placeholder="请输入6位验证码" />
                        </div>
                        <div class="col-33 f_right text-right tuCode">
                            <img src="__MODULE__/Tools/getThinkCode"  border="1" style="cursor: pointer;" title="看不清？点击更换另一个验证码。"/>
                        </div>
                    </div>
                    <div class="row no-gutter line_b">
                        <div class="col-25 text-left">
                            设置密码
                        </div>
                        <div class="col-75 line_l">
                            <input class="form-control gttv" type="password" name="password" placeholder="请输入6位以上非纯数字密码" />
                        </div>
                    </div>
                    <div class="row no-gutter line_b" >
                        <div class="col-25 text-left">
                            省&nbsp;&nbsp;份
                        </div>
                        <div class="col-75 pos_rela line_l">
                            <select class="form-control gttv" id="province-list" name='province'>
                            </select>
                            <span class="icon icon-right pos_arr" style=""></span>
                        </div>
                    </div>
                    <div class="row no-gutter line_b" >
                        <div class="col-25 text-left ">
                            城&nbsp;&nbsp;市
                        </div>
                        <div class="col-75 pos_rela line_l">
                            <select class="form-control gttv" id="city-list" name='city'>
                            </select>
                            <span class="icon icon-right pos_arr" style=""></span>
                        </div>
                    </div>
                    <div class="row no-gutter line_b">
                        <div class="col-25 text-left">
                            区&nbsp;&nbsp;域
                        </div>
                        <div class="col-75 pos_rela line_l">
                            <select class="form-control gttv" id="region-list" name='region'>
                            </select>
                            <span class="icon icon-right pos_arr" style=""></span>
                        </div>
                    </div>
                    <div class="row no-gutter line_b">
                        <div class="col-25 text-left item-title pos_rela line_r">
                            学&nbsp;&nbsp;校
                        </div>
                        <div class="col-75 pos_rela ">
                            <select class="form-control gttv" id="school-list" name='school'>
                            </select>
                            <span class="icon icon-right pos_arr" style=""></span>
                        </div>
                    </div>
                    <div class="row no-gutter line_b">
                        <div class="col-25 text-left pos_rela line_r">
                            年&nbsp;&nbsp;级
                        </div>
                        <div class="col-75 pos_rela ">
                            <select class="form-control gttv" id="grade-list" name='grade'>
                                <option value="1"></option>
                            </select>
                            <span class="icon icon-right pos_arr" style=""></span>
                        </div>    
                    </div> 
                    <div class="row no-gutter marg_top_10">
                        <input type="checkbox" name="agree"  value="checked" checked="checked" class="input_apper " />我已阅读<a href="__MODULE__/index/agreement" class="fcBlue">《萝卜兼职协议条款》</a>
                    </div>
                </div>
            </form>
            <div class="content-block">
                <div class="row">
                    <div class="col-100">
                        <a id="doNewReg" href="#" class="button button-big button_orange bg_reg">注&nbsp;&nbsp;册</a>
                    </div>
                </div>
            </div>
        </div>
	    <div class="tip_info text-center" style="display: none;"></div>
	</div>
    <include file="Common/footer"/>
    <script>
        $(function () {
            
            var time=60;
            var intervalId;
            
            function getCaptcha() {

                var phone = $("input[name='phone']").val();
                var verifyCode = $("input[name='verifyCode']").val();
  
                // 验证手机号
                var reg = /^0?1[3|4|5|8|7][0-9]\d{8}$/;
                if (!reg.test(phone)) {
                    $.toast("手机号码格式不正确啦!", 1000, "toast_orange");
                    return;
                } 

                // 获取手机验证码
                $.ajax({
                    type: 'POST',
                    url: MOD_PATH + '/Tools/getCaptcha', 
                    data: { phone : phone, verifyCode : verifyCode },
                    dataType: 'json',
                    timeout: 3000,
                    success: function(data){
                    	
                        if(!data.code) {
                            $.toast(data.msg);
                            return false;
                        } else {
                            $("input[name='phone']").attr("readonly", "readonly");
                            $("#getCaptcha").attr("disabled", "disabled");
                            $("#getCaptcha").css({"background": "gray"}); 
                            intervalId = setInterval(refreshGetCaptcha, 1000); 
                        }
                    },
                    error: function(xhr, type){
                    	
                        server_error();
                        location.reload();   
                    }
                });
            }

            function refreshGetCaptcha() {
                var btnCaptcha = $("#getCaptcha");
                btnCaptcha.html(time+ '秒后重发');
                time--;
                if(time < 0) {
                    clearInterval(intervalId);
                    $("input[name='phonecaptcha']").removeAttr("readonly");
                    btnCaptcha.removeAttr("disabled", "disabled");
                    btnCaptcha.css({"background": "#F3994F"});
                    btnCaptcha.html("获取验证码");
                    time = 60;
                }
            }
        
            // 获取验证码
            $('#getCaptcha').on('click', '', function (event) {
                event.preventDefault();
                getCaptcha();
            });

            // 点击注册
            $('#doNewReg').on('click', '', function (event) {

                event.preventDefault();
                var realName =$("input[name='realname']").val();
               
                if(realName=='' || realName==null)
                {
                	$.toast("真实姓名不能为空！", 1000, "toast_orange");  
                	 return false;
                }
                var phone =$("input[name='phone']").val();
                if(phone==''||phone==null)
                {
                	$.toast("手机号不能为空！", 1000, "toast_orange");  
                	 return false;
                }
                var password =$("input[name='password']").val();
                if(password==''||password==null)
                {
                	$.toast("密码不能为空！", 1000, "toast_orange");  
                	 return false;
                }
                var captcha =$("input[name='captcha']").val();
                if(captcha==''||captcha==null)
                {
                	$.toast("验证码不能为空！", 1000, "toast_orange");  
                	 return false;
                }
                
               

                // 客户端验证
                var reg = /^0?1[3|4|5|8|7][0-9]\d{8}$/;
                if (!reg.test($("input[name='phone']").val())) {
                    $.toast("手机号码格式不正确啦!");
                    return false;
                } 

                reg = /^\d+$/;
                var phoneCaptcha = $("input[name='captcha']").val();
                if (phoneCaptcha.length != 6 || !reg.test(phoneCaptcha)) {
                    $.toast("请输入6位数字验证码");                 
                    return false;
                }   

                var text = $("input[name='password']").val();
                if(!isPasswprd(text)){
                    $.toast("密码必须为6位以上的数字加字母组合", 1000, "toast_orange");  
                    return false;
                }
                

                if(!$("input[name='agree']").prop("checked")) {
                    $.toast("(^_^) 请先同意萝卜兼职协议条款！");
                    return false;
                }

                // 服务器端验证
                params=$("#form-reg").serialize();
                console.log(params);
              

                $.ajax({
                    type: 'POST',
                    url: MOD_PATH+'/Ad/signUpBeiJing', 
                    data: params,
                    dataType: 'json',
                    timeout: 3000,
                    success: function(data){
                    	
                    	console.log(params);
                        if(data.code==0)
                        {
                            $.toast("(^_^)"+data.msg);
                        }else if(data.code==1)
                        {
                            $.toast("(^_^) 恭喜您注册成功啦！");
                         
                            setTimeout(function(){
                                window.location.href= APP_PATH;
                            } ,1000);
                        
                        }
                        
                    },
                    error: function(xhr, type){
                        server_error();
                        location.reload();   
                    }
                });
            });
        });

        $(function () {   

            var currPId;
            var currCId;
            var currRId;
            var currSId;
            var provinces ={};
            $.ajax({
                type: 'POST',
                url:APP_PATH+ '/Home/Gp/citylist',
                dataType: 'json',
                timeout: 3000,
                success:getGPDataSuccess,
                error:function(){
                    server_error();
                }
            });

            function getGPDataSuccess(res){
                console.log(res.data);
                var datas = res.data;
                for (var i in datas){
                    provinces['p'+(datas[i].id)] = datas[i];
                }
                $("#province-list").html(template('province-list-tpl',{option:provinces, current:5}));
                $("#province-list").change(reRenderCityList);
                $('#province-list').trigger('change'); 
                $('#city-list').html(template('city-list-tpl',{option:provinces['p'+ (datas[0].id)].data}));
                $('#region-list').change(reRenderSchoolList);
                $('#city-list').change(reRenderRegionList);
                $('#province-list').trigger('change');
                $('#grade-list').html(template('grade-list-tpl',{option:[2012,2013,2014,2015,2016/*,2017,2018,2019,2020*/]}));
            }
     
            function reRenderCityList(){
                $('#city-list').html(template('city-list-tpl', { option : provinces['p'+ $(this).val()].data, current:21} ))
                              .trigger('change');
            }
            function reRenderRegionList(res){
                $.ajax({
                    type: 'POST',
                    url:APP_PATH+ '/Home/Gp/regionlist',
                    data:{cId:$('#city-list').val()},
                    dataType: 'json',
                    timeout: 3000,
                    context:$('#region-list'),
                    success:function(res){
                        console.log('region-list'+res.data);
                        this.html(template('region-list-tpl',{option:res.data}))
                                .trigger('change');
                    },
                    error:function(){
                        server_error();
                    }
                });
            } 
            function reRenderSchoolList(res){
                  $.ajax({
                    type: 'POST',
                    url:APP_PATH+ '/Home/Gp/schoolList',
                    data:{rId:$('#region-list').val()},
                    dataType: 'json',
                    timeout: 3000,
                    context:$('#school-list'),
                    success:function(res){
                        this.html(template('school-list-tpl',{option:res.data}));
                    },
                    error:function(){
                        server_error();
                    }
               });
            } 
        });
    </script>

    </body>
</html>

